<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="utf-8">
    <title>ReCS System</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
          integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
	<script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
		crossorigin="anonymous"></script>
	<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/css/select2.min.css" rel="stylesheet" />
	<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/js/select2.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.18.0/jquery.validate.min.js" ></script>

	<script type="text/javascript">
		
		jQuery.validator.addMethod("validateOfferName", function( value, element ) {
			var regex = new RegExp("^[a-zA-Z-\\s]+$");

			if (regex.test(value)) {
				return true;
			}
			return false;
		}, "Nazwa dania może zawierać jedynie litery, białe znaki oraz myślniki");
		
		jQuery.validator.addMethod("validateOfferNameBigLetter", function( value, element ) {
			var regex = new RegExp("^[A-Z]");

			if (regex.test(value)) {
				return true;
			}
			return false;
		}, "Nazwa dania z dużej litery");
		
		jQuery.validator.addMethod("validatePrice", function( value, element ) {
			var regex = new RegExp("^\\d{1,3}\\,?\\d{1,2}?$");
			var isComa = value.includes(',');
			
			if(isComa) {
				if (regex.test(value)) {
					return true;
				}
			} else if(value.length > 0 && value.length < 4){
				return true;
			}
			return false;
		}, "Cena w formacie 000,00");
		
		jQuery.validator.addMethod("validateDescription", function( value, element ) {
			var forbidden = ['#', '$', '^', '%', '&', '*', '!', '@'];
			return forbidden.every(function(f){return !value.includes(f)});
		}, "Pole nie może zawierać znaków specjalnych");
		
		jQuery(function($) {
			$("#form").validate({
				rules: {
					offerName: { 
						required: true, 
						validateOfferName: true,
						validateOfferNameBigLetter: true,
					},
					offerPrice: {
						required: true,
						validatePrice: true
					},
					offerDescription: {
						required: true,
						validateDescription: true
					}
				},
				messages: {
					offerName: { 
						required: '<div class="alert alert-danger" role="alert">Podaj nazwe dania</div>',
						validateOfferName: '<div class="alert alert-danger" role="alert">Nazwa dania może zawierać jedynie litery, białe znaki oraz myślniki</div>',
						validateOfferNameBigLetter: '<div class="alert alert-danger" role="alert">Nazwa dania z dużej litery</div>'
					},
					offerPrice: {
						required: '<div class="alert alert-danger" role="alert">Podaj cenę dania</div>',
						validatePrice: '<div class="alert alert-danger" role="alert">Cena w formacie 000,00</div>'
					},
					offerDescription: {
						required: '<div class="alert alert-danger" role="alert">Podaj opis dania</div>',
						validateDescription: '<div class="alert alert-danger" role="alert">Pole nie może zawierać znaków specjalnych</div>'
					}
				},
				submitHandler: function () {
					addOffer();
				}    
			});
		});
		
		function addOffer() {
			var host="http://localhost";
			//var port="5000";
			//var host="http://192.168.0.13";
			var port="8888";
			var endpoint="/dodaj_danie_restauracja";
			$.ajax({
				type: "POST",
				url: host+":"+port+endpoint,
				contentType:"application/json; charset=utf-8",
				data: JSON.stringify({
					id_restauracji: getUrlParameter('id_restauracji'),
					nazwa: $("#name").val(), 
					cena: $("#price").val(), 
					opis: $("#description").val()
				}),
				success: function(response){
					//json_obj = $.parseJSON(json);
					console.log(response);
					if(response == 'OK') {
						alert('Dodano potrawę!');
						window.location.replace('oferta_restauracji.html'+"?restaurant_id="+getUrlParameter('id_restauracji'));
					} else {
						alert(response);
					}
				},
				error: function () {
					alert('Nastąpił nieoczekiwany błąd połączenia. Spróbuj ponownie później.');
				}
			});
		}

		var getUrlParameter = function getUrlParameter(sParam) {
			var sPageURL = decodeURIComponent(window.location.search.substring(1)),
			sURLVariables = sPageURL.split('&'),
			sParameterName,
			i;

			for (i = 0; i < sURLVariables.length; i++) {
				sParameterName = sURLVariables[i].split('=');

				if (sParameterName[0] === sParam) {
					return sParameterName[1] === undefined ? true : sParameterName[1];
				}
			}
		};
	</script>
	
	<style>
	.error {
		width: 100% !important;
	}
	</style>
</head>
<body>
<ul class="nav nav-tabs">
    <li class="nav-item">
        <a class="nav-link" href="../mainpage.html">Strona główna</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="oferta_sieci.html">Oferta sieci</a>
    </li>
	<li class="nav-item">
        <a class="nav-link active" href="oferta_restauracji.html?restaurant_id=1">Oferta restauracji</a>
    </li>
</ul>
</ul>

<div class="row">
	<div class="col">
    </div>
    <div class="col-9">
        <form id="form">
			<input type="hidden" name="restaurant_id" value="1"/>
            <div class="form-group">
                <label for="name">Nazwa:</label>
                <input type="text" class="form-control" id="name" name="offerName" maxlength="30"/>
            </div>
            <div class="form-group">
                <label for="price">Cena:</label>
                <input type="text" class="form-control" id="price" name="offerPrice" maxlength="6"/>
            </div>
            <div class="form-group">
                <label for="description">Opis:</label>
                <textarea class="form-control" id="description" name="offerDescription" rows="3" maxlength="300"></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Dodaj</button>
            <a href="oferta_restauracji.html?restaurant_id=1" class="alert-link">
                <button type="button" class="btn btn-outline-primary">Anuluj</button>
            </a>
        </form>
    </div>
    <div class="col">
    </div>
</div>

</body>
</html>